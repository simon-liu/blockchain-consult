## 比特币钱包原理 - 生成私钥和地址

本文是分析比特币钱包如何生成私钥+地址对的，对非对称加密有兴趣的朋友可以看看这本书《Wiley.Understanding.Bitcoin.Nov.2014.ISBN.1119019168》第五章。

在 2013 年首次接触比特币钱包时，官方文档推荐每交易 100 次都要备份钱包，当然是备份钱包的私钥和地址。2 年前出于兴趣我研究了 MultiBit HD 的源码，在这过程中我发现并没有交易若干次必须备份钱包的说明，为什么呢？答案就是 HD（Hierarchical Deterministic），这个词很难翻译，我们还是看图吧：

![derivation](https://raw.githubusercontent.com/simon-liu/blockchain-consult/master/images/derivation.png)

最左边是128 位熵（借用了物理学高大上的名词），其实是个很大很随机的数字，把熵做一次 HASH 运算作为主密钥，接下来两层是人为划分出来，为了支持钱包的常见业务，最后一层就是钱包的私钥+地址对。我们发现把 `Wallet Chains` 拼接上『下标』就能『推导』出钱包的所有私钥+地址对，再仔细看一下，这几层『推导』都是 HASH 运算，运算的输入来自上一步的计算结果。

所以从 128 位熵就能推导出钱包的所有私钥+地址对。

对安全敏感的朋友马上意识到熵的生成方法尤其重要，从代码中看到熵是随机生成的 128 位随机数，为了便于用户备份，钱包会把这个随机数隐射成 12[^1] 个单词的助记符（MnemonicCode），使用过钱包的朋友肯定对这个有印象。助记符和熵可以互相转换，备份了助记符就等于备份了钱包，从此钱包备份不再烦恼。

文章结尾加个小插曲。在安全领域随机数的随机性尤其重要，一旦随机数有规律可寻，黑客就能利用这点来生成看似隐秘的信息。大部分时候规范、协议设计都没有漏洞，往往实现时没有选用安全的随机数生成器导致漏洞产生。比如网景公司早期的 OpenSSL 实现选择当天时间和进程ID作为随机数种子，随机数很容易被还原；再比如索尼未使用合适的随机数生成器导致 PS3 被破解；再比如 2013 年 8月 Android 平台随机数漏洞允许黑客恢复用户的比特币钱包私钥。

喜欢我的文章可以在[这里](https://github.com/simon-liu/blockchain-consult)和我交流。

[^1]: 创建钱包的时候，可选熵的位数：128/192/256，相应的助记符分别是 12/18/24 个单词